[TOC]

# 计算机网络基础

计算机网络的重要功能：连通性（彼此连通

交换信息）、共享（信息共享、软硬件共享）。

## 因特网概述

* 网络、互联网、因特网

网络是最小的单元，节点之间的连线叫做链路，通常链路不超过100米。网络中的“中枢”是交换机，交换机有非常多的网口用来连电脑。

![截屏2020-01-12下午6.41.34](计算机网络基础.assets/截屏2020-01-12下午6.41.34.png)

交换机组成的集群是**互联网**（Network of networks）

互联网是将每一个小的网络中的**交换机**连接起来，使用的机器是**路由器**，其网口4～5个。注意其符号。

![截屏2020-01-12下午6.43.38](计算机网络基础.assets/截屏2020-01-12下午6.43.38.png)

因特网是全球最大的一个互联网

![截屏2020-01-12下午6.45.29](计算机网络基础.assets/截屏2020-01-12下午6.45.29.png)

简而言之我们有：

| 规模   | 说明                 |
| ------ | -------------------- |
| 网络   | 很多计算机连接在一起 |
| 互联网 | 很多网络连接在一起   |
| 因特网 | 全球最大的一个互联网 |

* 因特网发展的三个阶段

![截屏2020-01-12下午6.54.50](计算机网络基础.assets/截屏2020-01-12下午6.54.50.png)

* 多层次ISP结构的互联网

![截屏2020-01-12下午6.57.19](计算机网络基础.assets/截屏2020-01-12下午6.57.19.png)

* 因特网的标准化工作

![截屏2020-01-12下午8.06.12](计算机网络基础.assets/截屏2020-01-12下午8.06.12.png)

## 因特网的组成

因特网可以分为核心部分和边缘部分。

![截屏2020-01-12下午8.08.30](计算机网络基础.assets/截屏2020-01-12下午8.08.30.png)

### 核心部分

能够让接入的计算机互连的设备集合。

### 边缘部分

加入系统的计算机，图中的边界。

主机（边缘）之间的通信方式有两种

1. 客户服务器方式（Client/Server）![截屏2020-01-12下午8.11.02](计算机网络基础.assets/截屏2020-01-12下午8.11.02.png)
2. 对等方式（Peer to Peer-p2p）

![截屏2020-01-12下午8.11.36](计算机网络基础.assets/截屏2020-01-12下午8.11.36.png)

每一个计算机同时也是服务器，所以文件可以实现在计算机之间的共享。下载人越多，速度越快。

#### 数据交换方式

* 电路交换

![截屏2020-01-12下午8.16.36](计算机网络基础.assets/截屏2020-01-12下午8.16.36.png)

相当于交换机内部将两个电话的线路连接起来了，在通话完毕之后将线路释放。

![截屏2020-01-12下午8.21.30](计算机网络基础.assets/截屏2020-01-12下午8.21.30.png)

实际中的应用如图所示。当电话A呼叫B时，交换机会根据电话号码的情况连接专线，显然，在线路接通之后AB之间的数据不需要对地址信息添加地址信息。

会出现占线的情况。

适合数据量十分巨大的情况，核心网路由之间可能使用这种方式。

* 报文交换

报文比分组长很多（一个完整的文件加上首部直接发送）

报文交换的时延较长。

* 分组交换（现在使用的）

![截屏2020-01-12下午8.25.53](计算机网络基础.assets/截屏2020-01-12下午8.25.53.png)

一个完整的文档叫做**报文**

首先将报文分割成数据，在前面添加**首部**

![截屏2020-01-12下午8.28.55](计算机网络基础.assets/截屏2020-01-12下午8.28.55.png)

在接受之后，根据首部的信息将数据拼接出来。

![截屏2020-01-12下午8.30.32](计算机网络基础.assets/截屏2020-01-12下午8.30.32.png)

如图，因为核心部分的连接线路很多，所以同一批数据包走的**可能不是用一条线路**。

这种方式并不存在占线的问题，分组转发不需要建立连接。

路由器有**存储转发**功能，在不同方向的接口上有队列，能够暂存数据。

![截屏2020-01-12下午8.39.54](计算机网络基础.assets/截屏2020-01-12下午8.39.54.png)

与电路交换对比在使用时并不需要建立专门的连接。

* 三种交换方式的比较

![截屏2020-01-12下午8.53.39](计算机网络基础.assets/截屏2020-01-12下午8.53.39.png)

回忆一下三种传送的详细工作，可以看出分组交换耗时最少。

## 计算机网络的类别

| 作用范围                                                     | 使用者             | 拓扑结构                                             | 交换方式   | 工作方式                           |
| ------------------------------------------------------------ | ------------------ | ---------------------------------------------------- | ---------- | ---------------------------------- |
| **广域网WAN**<br />城域网MAN<br />**局域网LAN**<br />个人区域网PAN | 公用网<br />专用网 | 总线型<br />环型<br />星型<br />树型<br />分组交换网 | 如上的三种 | 资源子网<br />通信子网<br />接入网 |
| 现在对于这个的区分主要看使用了**什么技术**，而不仅仅看覆盖范围<br />局域网是企业自己买设备自己维护，宽带固定，网线100M<br />广域网花钱买服务，花钱买带宽 |                    |                                                      |            |                                    |

## 计算机网络的性能

### 速率

连接在计算机网络的主机在**数字信道**上传送数据位数的速率，单位是b/s,kb/s,mb/s,gb/s

电信运营商所说的100M宽带事实上是**100Mbps**，换算成速率要除以8！

注意这里所说的速率是指一个发送端一个接收端中间传送数据的速度，而不是计算机同时下载很多东西时的总速度！应当分开来看！

### 带宽

数字通信领域中，数字信道所传送的**最高速率**。

比如我们所说的100M网卡就是指这个，与实际的速度无关。

### 吞吐量

单位时间内通过某个网络的数据量（没有说是信道了！）

计算机只有一块网卡时，其吞吐量就是通过网卡的所有流量的和。

### 时延

* 发送时延![截屏2020-01-12下午9.19.51](计算机网络基础.assets/截屏2020-01-12下午9.19.51.png)
* 传播时延![截屏2020-01-12下午9.20.42](计算机网络基础.assets/截屏2020-01-12下午9.20.42.png)
* 处理时延
* 排队时延

### 时延带宽积

![截屏2020-01-12下午9.44.50](计算机网络基础.assets/截屏2020-01-12下午9.44.50.png)

### 往返时间

ping出来

### 利用率

![截屏2020-01-12下午9.49.05](计算机网络基础.assets/截屏2020-01-12下午9.49.05.png)

## 体系结构

ISO——国际标准化组织

OSI/RM——互联网法律上的国际标准

TCP/IP Suite——互联网事实上的国际标准

Network Protocols——数据交换遵守的规则、标准或约定

网络体系结构——计算机各层及其协议的集合

### OSI参考模型

| 名称                           | 说明                                                         |
| ------------------------------ | ------------------------------------------------------------ |
| 应用层                         | 能够产生网络流量能够和用户交互的应用程序，比如QQ等，记事本不是 |
| 表示层                         | 加密、压缩                                                   |
| 会话层                         | 服务和客户端建立的会话，使用netstat可以看到所有建立的连接    |
| 以上软件工程师，一下网络工程师 | -                                                            |
| 传输层                         | 建立可靠的会话、不可靠传输、流量控制                         |
| 网络层                         | IP地址编址，选择最佳路径                                     |
| 数据链路层                     | 输入如何封装、添加物理层地址：MAC                            |
| 物理层                         | 电压、接口标准                                               |

网络排错使用由下至上的办法

### 物理层安全

* 物理层安全 网线接口可被别人利用，接入内网
* 数据链路层安全 ADSL的账号密码、无限AP的密码安全
* 网络层安全 设定IP段能否访问Internet
* 应用层安全 SQL注入漏洞

### 开放式信息交换

* 实体——交换信息的硬件或软件过程
* 协议——控制两个对等的实体通信
* 服务——下层向上层提供服务，上层需要使用下层提供的服务来实现本层功能
* 服务访问点——相邻两层实体间交换信息的地方（一个转换函数之类……）



![截屏2020-01-12下午10.43.26](计算机网络基础.assets/截屏2020-01-12下午10.43.26.png)

## 计算机网络的体系结构

![截屏2020-01-13下午5.33.05](计算机网络基础.assets/截屏2020-01-13下午5.33.05.png)

![截屏2020-01-13下午5.35.02](计算机网络基础.assets/截屏2020-01-13下午5.35.02.png)

![截屏2020-01-13下午5.35.36](计算机网络基础.assets/截屏2020-01-13下午5.35.36.png)

### 虚拟机网络配置

在编辑——编辑虚拟网络中：

* 如果要让两台虚拟机互通，一定要保证两台机器使用同一个虚拟网络（VMNet）
* 在列表中桥接模式（Bridged）的交换机与物理网络相连（一般是VMNet0），如果将虚拟机的网卡设置为此，则此虚拟机将暴露在物理网络上。

下面是虚拟机设置界面：

![截屏2020-01-13下午5.59.03](计算机网络基础.assets/截屏2020-01-13下午5.59.03.png)

如果想让主机和虚拟机相通，一定要保证其在一个网段下，在同一块网卡内。

NAT地址转换：其内部产生的数据包在发送时会自动替换成主机的IP地址，实现主机取回数据后再分发给虚拟机。在NAT设置的IP地址为内部虚拟机的**网关**![截屏2020-01-13下午6.08.23](计算机网络基础.assets/截屏2020-01-13下午6.08.23.png)

# 物理层

物理层解决如何在连接各种计算机的传输媒体上传输数据比特流而不是指具体的传输媒体。

主要任务：确定与传输媒体的接口的一些特性。

![截屏2020-01-13下午6.17.14](计算机网络基础.assets/截屏2020-01-13下午6.17.14.png)

### 数据通信的基础知识

![截屏2020-01-13下午6.22.15](计算机网络基础.assets/截屏2020-01-13下午6.22.15.png)

![截屏2020-01-13下午6.25.50](计算机网络基础.assets/截屏2020-01-13下午6.25.50.png)

码元：一段时间内的一个波形

![截屏2020-01-13下午6.28.50](计算机网络基础.assets/截屏2020-01-13下午6.28.50.png)

基带信号：产生的最原始的信号，比如说话的声波

而带通信号则是经过调制的。

![截屏2020-01-13下午6.30.49](计算机网络基础.assets/截屏2020-01-13下午6.30.49.png)

![截屏2020-01-13下午6.32.23](计算机网络基础.assets/截屏2020-01-13下午6.32.23.png)

#### 常用编码

单极性不归零码/归零码

双极性不归零码/归零码

曼彻斯特编码（上升沿为0，下降沿为1。为了解决无法识别结束信号的问题）

查分曼彻斯特编码（通过两次取样，有跳变是0，无跳变是1）抗干扰强于曼彻斯特编码

![截屏2020-01-13下午6.41.57](计算机网络基础.assets/截屏2020-01-13下午6.41.57.png)

![截屏2020-01-13下午6.42.40](计算机网络基础.assets/截屏2020-01-13下午6.42.40.png)

可以明显看到区别：在连续1的时候归零码会回到1

![截屏2020-01-13下午6.43.28](计算机网络基础.assets/截屏2020-01-13下午6.43.28.png)

![截屏2020-01-13下午6.43.52](计算机网络基础.assets/截屏2020-01-13下午6.43.52.png)

查分的不好理解：当前区间内的信号要看前一条线的两边是否有跳变，有跳变是0，无跳变是1。

![截屏2020-01-13下午8.19.04](计算机网络基础.assets/截屏2020-01-13下午8.19.04.png)

### 信道的极限容量

#### 奈氏准则

在假定的理想条件下，为了避免码间串扰，码元的传输速率的上限值。

任何信道中，码元的传输速率是有上限的，否则就会出现码间串扰的问题，使接受端对码元的判决成为不可能。

如果信道的频带越宽，也就是能够通过的信号高频分量越多，那么就可以用更高的速率传送码元而不出现码间串扰。

（理解：如果说话加速太快，就无法分辨内容了。同时，将声音加速之后会变尖，于是带宽越宽，高频越多）

![截屏2020-01-13下午8.33.43](计算机网络基础.assets/截屏2020-01-13下午8.33.43.png)

#### 信噪比

![截屏2020-01-13下午8.38.27](计算机网络基础.assets/截屏2020-01-13下午8.38.27.png)

通过公式我们知道，在有噪声时传输速率会降低，也就是说在有噪声干扰时应将传输速度降下来。



![截屏2020-01-13下午8.42.54](计算机网络基础.assets/截屏2020-01-13下午8.42.54.png)

注意两个准则是适用范围！

![截屏2020-01-13下午9.16.59](计算机网络基础.assets/截屏2020-01-13下午9.16.59.png)

### 物理层下面的传输媒体

![截屏2020-01-13下午8.46.07](计算机网络基础.assets/截屏2020-01-13下午8.46.07.png)

导向传输媒体

![截屏2020-01-13下午8.48.11](计算机网络基础.assets/截屏2020-01-13下午8.48.11.png)

![截屏2020-01-13下午8.53.27](计算机网络基础.assets/截屏2020-01-13下午8.53.27.png)

![截屏2020-01-13下午8.54.35](计算机网络基础.assets/截屏2020-01-13下午8.54.35.png)

非导向通信

![截屏2020-01-13下午8.56.35](计算机网络基础.assets/截屏2020-01-13下午8.56.35.png)

![截屏2020-01-13下午8.58.56](计算机网络基础.assets/截屏2020-01-13下午8.58.56.png)

使用集线器的网络是半双工（同时只能一个信道）的，其中的一台计算机发出信息其他计算机都能收到。

### 信道复用技术

![截屏2020-01-13下午9.22.43](计算机网络基础.assets/截屏2020-01-13下午9.22.43.png)

* 频分复用技术

![截屏2020-01-13下午9.25.50](计算机网络基础.assets/截屏2020-01-13下午9.25.50.png)

相当于不同的人使用不同的频率，在信息波上面调制不同的基础频率，在接收的时候能够将其分开。

![截屏2020-01-13下午9.26.49](计算机网络基础.assets/截屏2020-01-13下午9.26.49.png)

![截屏2020-01-13下午9.29.36](计算机网络基础.assets/截屏2020-01-13下午9.29.36.png)

电话机使用的就是频分复用技术！

![截屏2020-01-13下午9.32.25](计算机网络基础.assets/截屏2020-01-13下午9.32.25.png)

* 时分复用技术

![截屏2020-01-13下午9.33.53](计算机网络基础.assets/截屏2020-01-13下午9.33.53.png)

![截屏2020-01-13下午9.34.53](计算机网络基础.assets/截屏2020-01-13下午9.34.53.png)

![截屏2020-01-13下午9.37.12](计算机网络基础.assets/截屏2020-01-13下午9.37.12.png)

![截屏2020-01-13下午9.37.25](计算机网络基础.assets/截屏2020-01-13下午9.37.25.png)

![截屏2020-01-13下午9.38.11](计算机网络基础.assets/截屏2020-01-13下午9.38.11.png)

如图我们可以认为是一个旋转的机关，按照顺序将信号放上去

缺点：在某个用户不使用时会占空，线路的利用率不高

* 统计时分复用

![截屏2020-01-13下午9.41.38](计算机网络基础.assets/截屏2020-01-13下午9.41.38.png)

可以看出，现在我们将数据打上标记，这样的话就不会有占空了！

* 波分复用

事实上就是频分复用，只不过在处理光

![截屏2020-01-13下午9.45.58](计算机网络基础.assets/截屏2020-01-13下午9.45.58.png)

* 码分复用技术

![截屏2020-01-18上午8.23.05](计算机网络基础.assets/截屏2020-01-18上午8.23.05.png)

![截屏2020-01-18上午8.30.34](计算机网络基础.assets/截屏2020-01-18上午8.30.34.png)

CDMA手机接受的**信号相同**，怎样才能保证其收到的信息不被其他人窃听呢？

相当于将bit再分割，每一个终端的比特1所定义的码片序列是不同的，这样就保证这段信号使用正确的码片做**正交积**（将收到的信号的对应位置与码片定义的序列对应位置相运算）之后才是正确的信号。

在图中要注意这种通信我们使用1与-1表示数据，在传输时使用原码表示1，反码表示-1，则不难得出以下性质：

原码·原码 == 1， 反码·原码 == -1；

![截屏2020-01-18上午11.20.04](计算机网络基础.assets/截屏2020-01-18上午11.20.04.png)

同时为了确保其正常工作，不同的码片应当是正交的。

现在就有问题：收到码片序列之后计算每一个码片对应的信号：

![截屏2020-01-18上午11.21.27](计算机网络基础.assets/截屏2020-01-18上午11.21.27.png)

注意在计算格式化内积的时候应当处以向量维数！自己算的时候忘记做除法了！最后我们应当只计算出1、-1 or 0！

码分复用缺点：发送1bit需要的数据量很大，数据传送困难。

### 数字传输技术

在电话通信局使用。

![截屏2020-01-18上午11.29.20](计算机网络基础.assets/截屏2020-01-18上午11.29.20.png)

主要讲了两个标准，我国使用的是E1标准。E1使用32语音信道，T1采用24信道，并且前者的控制信号每一条信道都有，而后者则是整体有一个。

![截屏2020-01-18上午11.34.04](计算机网络基础.assets/截屏2020-01-18上午11.34.04.png)

上图是E1标准，下图是T1标准。

![截屏2020-01-18上午11.34.40](计算机网络基础.assets/截屏2020-01-18上午11.34.40.png)

### 带宽接入技术

ADSL：通过电话线使用频分复用技术将低频分给通话，高频分给通信。

同轴电缆：将有线电视的线接入互联网。

Fbbx：光纤到x，可以到路边、小区、到家等。就是拉一根光纤，根据成本计算的。

# 数据链路层

![截屏2020-01-18下午5.07.17](计算机网络基础.assets/截屏2020-01-18下午5.07.17.png)

![截屏2020-01-18下午5.07.41](计算机网络基础.assets/截屏2020-01-18下午5.07.41.png)

本节我们只研究链路层到链路层的传输方式。

在物理层系统传输的光信号、01数字序列，那么在链路层系统传输的是帧，也就是经过封装的数据报，里面封装了Mac地址，有头和尾。

![截屏2020-01-18下午5.11.42](计算机网络基础.assets/截屏2020-01-18下午5.11.42.png)

**点对点信道**：只有两台计算机中间没有其他转发设备

**广播信道**：一个人通信所有人都能收到（当然大多时候是忽略的）

### 数据链路层的三个基本问题

#### 封装成帧

![截屏2020-01-18下午5.16.07](计算机网络基础.assets/截屏2020-01-18下午5.16.07.png)

MTU：最大传输单元，不能超过1500字节。

![截屏2020-01-18下午5.17.34](计算机网络基础.assets/截屏2020-01-18下午5.17.34.png)

如果出现问题，对方计算机没有收到完整的帧，则会将其丢掉；只收到结束标志的也会丢弃。所以说用帧界定数据是很有必要的。

#### 透明传输

![截屏2020-01-18下午5.23.23](计算机网络基础.assets/截屏2020-01-18下午5.23.23.png)

![截屏2020-01-18下午5.23.39](计算机网络基础.assets/截屏2020-01-18下午5.23.39.png)

通过在前面插入ESC消除转义字符。

因为在传输过程中加了一些转义字符，在接收时又删除了，双方并不知道做了什么，于是得名透明传输。

#### 差错控制

![截屏2020-01-18下午5.25.26](计算机网络基础.assets/截屏2020-01-18下午5.25.26.png)

![截屏2020-01-18下午5.26.03](计算机网络基础.assets/截屏2020-01-18下午5.26.03.png)

**CRC出现了！**

![截屏2020-01-18下午5.26.15](计算机网络基础.assets/截屏2020-01-18下午5.26.15.png)

为了保证传输时数据的准确性，需要添加冗余以便检查其准确性。详细的计算方法如下：

1. 在被传输数据后面添加n个0（n由网卡协商）
2. 选择一个n+1位的数字（同样由网卡协商）
3. 进行除法运算，其中**两数相减为异或运算**。
4. 最后会得到一个n位余数，作为帧检验序列FCS
5. 在接收端计算组合后的数字除以协商数字，如果没有问题则余数为0。

注意：FCS是添加的冗余信息，CRC是一种计算方式。

![截屏2020-01-18下午5.45.41](计算机网络基础.assets/截屏2020-01-18下午5.45.41.png)

注意：在当前的模式下如果在传输的过程中发生校验失败，则会**直接丢弃，并不会要求对方重发**（这不是链路层的职责）

同时，这种校验方式也有失败的可能。

### 点到点通信-PPP协议

![截屏2020-01-18下午5.53.44](计算机网络基础.assets/截屏2020-01-18下午5.53.44.png)

使用账号密码认证，之后会分配一个IP地址，同时系统会记录用户的上网时间、账户计费等信息。

直接网线上网的不使用此协议。

![截屏2020-01-18下午5.59.02](计算机网络基础.assets/截屏2020-01-18下午6.06.03.png)

#### PPP协议帧格式

#### ![截屏2020-01-18下午7.29.19](计算机网络基础.assets/截屏2020-01-18下午7.29.19.png)

![截屏2020-01-18下午7.29.50](计算机网络基础.assets/截屏2020-01-18下午7.29.50.png)

为了避免冲突，在传输不同数据时有不同方式处理7E冲突：

关键在于数据是怎样看待的，有时候以8bit看作字节，有时则是直接看成比特信息。

**字节填充方式**

![截屏2020-01-18下午7.31.17](计算机网络基础.assets/截屏2020-01-18下午7.31.17.png)

**零比特填充方式**

![截屏2020-01-18下午7.32.12](计算机网络基础.assets/截屏2020-01-18下午7.32.12.png)![截屏2020-01-18下午7.34.09](计算机网络基础.assets/截屏2020-01-18下午7.34.09.png)

![截屏2020-01-18下午7.28.47](计算机网络基础.assets/截屏2020-01-18下午7.28.47.png)

#### PPP协议的工作状态

![截屏2020-01-18下午7.38.16](计算机网络基础.assets/截屏2020-01-18下午7.38.16.png)

![截屏2020-01-18下午7.38.45](计算机网络基础.assets/截屏2020-01-18下午7.38.45.png)

### 使用广播信道的数据链路层

刚才我们学习的是点对点通信的协议。

![截屏2020-01-18下午8.20.23](计算机网络基础.assets/截屏2020-01-18下午8.20.23.png)

![截屏2020-01-18下午8.24.49](计算机网络基础.assets/截屏2020-01-18下午8.24.49.png)

![截屏2020-01-18下午8.26.53](计算机网络基础.assets/截屏2020-01-18下午8.26.53.png)

![截屏2020-01-18下午8.29.43](计算机网络基础.assets/截屏2020-01-18下午8.29.43.png)

注意：同时只能两台计算机通信，信道还是会被占的！

![截屏2020-01-18下午8.32.56](计算机网络基础.assets/截屏2020-01-18下午8.32.56.png)

在计算机发包的时候，首先会检测线路中有没有正在通信的，如果有则会等待其接收之后再发送。

![截屏2020-01-18下午8.37.39](计算机网络基础.assets/截屏2020-01-18下午8.37.39.png)

碰撞检测原理

![截屏2020-01-18下午9.12.49](计算机网络基础.assets/截屏2020-01-18下午9.12.49.png)

A发送出数据之后如果在2t的时间内都没有检测到异常，则说明没有产生冲突。同时在这里我们知道以太网不能太长，否则二者之间的通信冲突处理会非常麻烦。

![截屏2020-01-18下午9.14.33](计算机网络基础.assets/截屏2020-01-18下午9.14.33.png)

因为其存在冲突，所以在发送数据时最多只能做到半双工。

因为两端计算机并不知道对方何时会发送数据，于是并不会真的去等2t时间，而是在这个时间依然发送数据最多可以发512Bit64字节，如果发现中间产生冲突则立即放弃发送。以太网之所以规定最短帧长就是为了保证传输包的完整性。

#### 二进制指数类型退避算法

![截屏2020-01-18下午9.22.12](计算机网络基础.assets/截屏2020-01-18下午9.22.12.png)

注意：在取出r值之后，实际的的等待时间为r * 2t

概述、介绍略。

![截屏2020-01-18下午10.16.52](计算机网络基础.assets/截屏2020-01-18下午10.16.52.png)

### 以太网的信道利用率

#### ![截屏2020-01-18下午9.58.45](计算机网络基础.assets/截屏2020-01-18下午9.58.45.png)

时间等于长度除以时间。

![截屏2020-01-18下午9.59.49](计算机网络基础.assets/截屏2020-01-18下午9.59.49.png)

![截屏2020-01-18下午10.01.16](计算机网络基础.assets/截屏2020-01-18下午10.01.16.png)

![截屏2020-01-18下午10.03.54](计算机网络基础.assets/截屏2020-01-18下午10.03.54.png)

### MAC层（MAC地址）

![截屏2020-01-18下午10.14.04](计算机网络基础.assets/截屏2020-01-18下午10.14.04.png)

![截屏2020-01-18下午10.18.04](计算机网络基础.assets/截屏2020-01-18下午10.19.32.png)

![截屏2020-01-18下午10.20.25](计算机网络基础.assets/截屏2020-01-18下午10.20.25.png)

与以太网标准相同

![截屏2020-01-18下午10.21.00](计算机网络基础.assets/截屏2020-01-18下午10.21.00.png)

注意：从这里我们可以看出在物理层的数据包只有开始没有结束，因为以太网使用曼彻斯特编码，只要没有跳变就代表数据包结束。

![截屏2020-01-18下午10.43.45](计算机网络基础.assets/截屏2020-01-18下午10.43.45.png)

### 扩展以太网

![截屏2020-01-18下午10.48.49](计算机网络基础.assets/截屏2020-01-18下午10.48.49.png)

![截屏2020-01-18下午10.51.53](计算机网络基础.assets/截屏2020-01-18下午10.51.53.png)

![截屏2020-01-18下午11.04.17](计算机网络基础.assets/截屏2020-01-18下午11.04.17.png)通过记录数据包源mac地址的方式从而知道每一个计算机所在的端口，这样再发送数据包时就不会将其扩散到整个终端了。

![截屏2020-01-18下午11.04.41](计算机网络基础.assets/截屏2020-01-18下午11.04.41.png)

![截屏2020-01-18下午11.05.29](计算机网络基础.assets/截屏2020-01-18下午11.05.29.png)

##### 待补：自学习算法

现在使用的交换机就是高速网桥，其每一个端口连接一个设备，并不会出现冲突的问题，同时安全性也有提升，因数据包不会扩散到整个网络从而避免被抓包。

##### 最小生成树算法

如果交换机内部产生环，就会产生网络风暴，使得封包在内部不断兜圈子。所以要使用一些算法来避免环的生成。

![截屏2020-01-19下午7.03.24](计算机网络基础.assets/截屏2020-01-19下午7.03.24.png)

使用生成树协议可以阻断环。

算法过程：

1. 在拓扑网络中选择一个Mac地址最小的作为根
2. 选择**剩下的所有交换机**中的离根最近的端口——称为根端口
3. 选择没有**标记的所有线**中离根最近的端口——称为指定端口
4. 既不是根端口也不是指定端口的称为——阻断端口，不转发用户数据

![截屏2020-01-19下午7.16.58](计算机网络基础.assets/截屏2020-01-19下午7.16.58.png)

如图中标记X的位置是阻断端口

注意：当一根线的一端为阻断端口，另一端不是阻断端口时，另一端依然是正常工作的，因为线路中间的集线器是不参与生成树网络的，所以「一端阻断、另一端正常是合理的！」

### 虚拟局域网

![截屏2020-01-19下午7.41.13](计算机网络基础.assets/截屏2020-01-19下午7.41.13.png)

有时我们需要不在物理局域网的计算机组成一个局域网，这就是虚拟局域网。

如图物理局域网是横向的计算机，但是实际要求纵向成局域网。

#### 创建和管理VLAN

![截屏2020-01-19下午7.44.49](计算机网络基础.assets/截屏2020-01-19下午7.44.49.png)

如果我们将交换机的左右端口分成两个虚拟局域网，则可以看成是两个交换机，他们广播不能穿透彼此。

![截屏2020-01-19下午8.02.11](计算机网络基础.assets/截屏2020-01-19下午8.02.11.png)

## 网络层

### 网络层提供的两种服务

![截屏2020-01-19下午8.24.38](计算机网络基础.assets/截屏2020-01-19下午8.24.38.png)

为了提高传输效率，可靠交付实际由端系统提供。

虚电路

![截屏2020-01-19下午8.26.22](计算机网络基础.assets/截屏2020-01-19下午8.26.22.png)

在配置了虚电路之后，数据包就只会沿着这条线路传送数据，即使存在其他线路也不会使用。

数据报服务

![截屏2020-01-19下午8.28.27](计算机网络基础.assets/截屏2020-01-19下午8.28.27.png)

数据报中都有发送的源地址和目标地址，在网络中会根据最佳的路线传送，更加灵活多变。

![截屏2020-01-19下午8.34.59](计算机网络基础.assets/截屏2020-01-19下午8.34.59.png)

现在互联网使用的是数据报服务……没有虚电路

### 网际协议IP

#### 虚拟互联网

![截屏2020-01-19下午8.41.14](计算机网络基础.assets/截屏2020-01-19下午8.41.14.png)

转发器相当于放大器，当下网关成为了路由器的一个接口。

![截屏2020-01-19下午8.44.52](计算机网络基础.assets/截屏2020-01-19下午8.44.52.png)

配置网关主要是为了访问其他网段，如果不配置/配置错误，则无法出去，同网段的访问是没有问题的。

### 网络互联的问题

![截屏2020-01-19下午8.47.49](计算机网络基础.assets/截屏2020-01-19下午8.47.49.png)

### 互联网络和虚拟互联网络

![截屏2020-01-19下午8.51.37](计算机网络基础.assets/截屏2020-01-19下午8.51.37.png)

![截屏2020-01-20上午4.22.02](计算机网络基础.assets/截屏2020-01-20上午4.22.02.png)

![截屏2020-01-20上午4.23.37](计算机网络基础.assets/截屏2020-01-20上午4.23.37.png)

### IP地址

前三部分类似区号，后面是主机号。

![截屏2020-01-20上午4.35.30](计算机网络基础.assets/截屏2020-01-20上午4.35.30.png)

![截屏2020-01-20上午4.41.43](计算机网络基础.assets/截屏2020-01-20上午4.41.43.png)

从上图我们可以看出，取IPv4地址的一部分，通过数开头有几个连续的1就可以判断其地址的类型了。注意地址的取值区间不要回答错误。

计算机中的**子网掩码**就是为了区分IP地址中的网络部分和主机部分，自动填充的原理也是判断第一位有多少个1！

![截屏2020-01-20上午4.55.26](计算机网络基础.assets/截屏2020-01-20上午4.55.26.png)

 路由器的不同端口网段必须不同，网络号必须相同。

#### 特殊地址

| IP地址                       | 说明                              |
| ---------------------------- | --------------------------------- |
| 127.0.0.1                    | 本地环回地址                      |
| 169.254.0.0                  | Windows自动获取IP失败时自动生成的 |
| 10.0.0.0                     | 保留A类地址                       |
| 172.16.0.0 ～ 172.31.0.0     | 保留B类地址                       |
| 192.168.0.0 ～ 192.168.255.0 | 保留C类地址                       |

子网掩码就是为了划分网络段和主机端，计算机产生通信包有两个选择，可以在当前所在内网中计算机相互通信。或者发给网关路由出去。这个要看掩码配置了。

也就是说如果主机“认为是同一网段”，则不会发给路由。

#### 子网划分

哪怕是C类地址，其也能容纳255台设备。但是为了节省IP地址，我们要最大化利用网段。

我们可以自定义子网掩码从而让计算机实现更加细致的网段划分。

例如C类地址要将200台计算机划分两个网段，最简单的当然是192.168.0.0和192.168.1.0两个，但是这样浪费极大，我们可以自定义子网掩码地址为255.255.255.128 这样在**192.168.0.1～126**是一个网段，**192.168.0.129～254**是一个网段了！

注意：IP地址主机部分全为0代表网段，全为1代表广播，所以这两个特殊地址要排除。这个要求是在**实际子网掩码划分下的**，所以要灵活使用！

![截屏2020-01-20上午8.56.24](计算机网络基础.assets/截屏2020-01-20上午8.56.24.png)

![截屏2020-01-20上午8.57.10](计算机网络基础.assets/截屏2020-01-20上午8.57.10.png)

上图是当前情景下的IP和子网掩码分配情况。注意路由器也需要分配地址，一般为当前集群的第一个。

下面是划分成4个网段的例子：

![截屏2020-01-20上午9.07.27](计算机网络基础.assets/截屏2020-01-20上午9.07.27.png)

![截屏2020-01-20上午9.09.46](计算机网络基础.assets/截屏2020-01-20上午9.09.46.png)

在点到点的网络中子网掩码应该怎样计算呢？

我们使用数轴法不断选择最合适的区间，本题为0～4。

关键经验：**除一次二，子网掩码后移一位。**

**易错点**：因为要划分成两个段，那么里面一定不能使用的全零、全一、路由预留地址等。所以我们划分到0～4是最合适的，子网掩码255.255.255.252。

#### 变长子网掩码

![截屏2020-01-20上午9.37.28](计算机网络基础.assets/截屏2020-01-20上午9.37.28.png)

可以看到子网掩码不再相同，我们要注意计算的细节。注意路由设备等的IP地址划分，注意可用IP段的书写！

**活学活用**

问：知道IP地址和子网掩码，怎样确定其在那一个IP段呢？

现在我们说的子网掩码，已经不是一个“平分”概念了，而是可以说明在**当前IP所在网段的网段长度**了。所以我们可以使用数轴法，通过掩码推算划分次数，不断向目标IP逼近即可。

![image-20200120103305389](计算机网络基础.assets/image-20200120103305389.png)

**子网掩码的不同表示**

因为子网掩码就是一堆从开头开始的连续的1，所以我们还可以描述1的个数来说明子网掩码的情况。

这样做的好处是我们可以非常方便求解/看出当前网段中的计算机容量，公式为:

3 * 8 + 最佳区间划分次数

同时有一些题目可能还会给出IP地址判断，自然不能是全1Or全0的，所以我们可以将主机地址除以4，余数为1和2的是可以的，0和3是不行的。

![image-20200120103846291](计算机网络基础.assets/image-20200120103846291.png)

#### B类网络子网划分

这里只说了划分成两个的情形，非常简单呀！

### 超网

子网划分的逆操作，现在给定两个网段，要求设计一个子网掩码可以合并两个网段。

![image-20200120105401569](计算机网络基础.assets/image-20200120105401569.png)

![image-20200120105425511](计算机网络基础.assets/image-20200120105425511.png)

合并网段的现实意义如上图所示。

那么合并之后左右的地址归到哪一个地址了呢？将主机部分清零。

但是并不是所有的地址都可合并。例如说1和2合并后会同时将0、1、2、3都合并，这样会出现问题。

首先要合并的必须是连续的，其次最小的开始地址必须为偶数，并且长度是2的幂次！

#### 数据包转发过程

![image-20200120112149957](计算机网络基础.assets/image-20200120112149957.png)

如果全世界所有的设备都在局域网（Ethernet）中，则不需要IP地址

在路由转发的过程中，数据包的MAC地址会发生改变（发送地址会变成路由器的）所以通过Mac地址只能管理相同网段的，其他网段无法管理；使用IP地址则没有这个问题。

### ARP和RARP

ARP协议通过**广播**将IP地址转换为MAC地址

RARP是其逆协议，通过Mac地址请求IP地址

ARP欺骗：在AB进行通信时，A会发送广播来询问B的mac地址，这时候中间人C发送自己的地址到A处（此处并不会对信息真实性进行校验），建立通信之后再将数据包转发给B，这样就实现了数据帧的截获。

### IP数据报

![image-20200120133217049](计算机网络基础.assets/image-20200120133217049.png)

下面我们将详细研究首部内部：

![image-20200120143209657](计算机网络基础.assets/image-20200120143209657.png)

| 成分        | 说明                                                         |
| ----------- | ------------------------------------------------------------ |
| 版本        | 用于说明是ipv4还是ipv6                                       |
| 首部长度    | 因为首部手机是可变的，所以需要规定其长度                     |
| 区分服务    | QoS，用于说明包的传输紧迫性，一般需要实地路由配置            |
| 总长度      | 整个数据包的长度                                             |
| 标识        | 计数器，产生数据报的标识，每产生一个数据包++                 |
| 标志        | 用于说明是否分片传输                                         |
| 片偏移      | 会将数据包分片，每一片的首地址除以8作为内容。因为数据包的长度不能超过MCU |
| 生存时间TTL | 用于说明数据包可以经过的最大路由器个数                       |
| 协议        | 接近传输层协议，TCP、UDP等                                   |
| 首部检验和  | 仅检查首部信息，将其内容二进制16bit为一段，加和取反码作为校验数据，检验时同样方法，看最后的结果是否为0 |
| 。。        | 。。                                                         |

#### 数据包路由

数据路由：路由器在不同网段转发数据包。

网络畅通的条件：能去能回。

沿途的路由器必须知道到目标网络下一跳给哪个接口，vise versa

* 静态路由

管理员必须将当前路由器在周围的所有非直联IP都登记进去，这样当前路由才知道后面应该怎样走。

![image-20200120154351247](计算机网络基础.assets/image-20200120154351247.png)

在模拟环境中我们感受一下

![image-20200120155342495](计算机网络基础.assets/image-20200120155342495.png)

问题：PC0 ping 172.16.0.2 能通吗？

不能通。根据有去有回原则，从PC到Router0-0 -> Router0-1是没问题的，Router0-1 -> Router1-2也是没问题的（因为直联），但是从Router1返回时，其不知道192.168网段应该走2还是1，于是将数据包丢弃，超时。

解决：在Router1中添加静态路由信息：192.168网段跳到172.16.0.1，这样算是满足下一跳了。

问题：计算机有两个网卡，一张连接Internet，另一张连接小型局域网，外网ping时时通时断？

解决：删除连接局域网的网关，设置Internet的网关。因为访问Internet是需要网关进行地址转发的，但是局域网内互相访问就是广播的方式，不能添加网关！

本质：交换机与路由器的区别。

#### 网络负载均衡

配置路由表就完事了。相当于图论加边。

### ICMP协议

![image-20200120185141927](计算机网络基础.assets/image-20200120185141927.png)

![image-20200120185318314](计算机网络基础.assets/image-20200120185318314.png)

![image-20200120190411660](计算机网络基础.assets/image-20200120190411660.png)

| 差错类型     | 说明                                                         |
| ------------ | ------------------------------------------------------------ |
| 终点不可到达 | 信息传递时某路由不知数据包应当怎样传递，于是在废弃数据包的同时返回此消息 |
| 源点抑制     | 发送的数据包过于频繁                                         |
| 时间超时     |                                                              |
| 参数问题     |                                                              |
| 改变路由     | 如果某数据包发送后路由发现了更好的线路，则会返回此消息，下次发送时将选择更优的路由 |

![image-20200120190842704](计算机网络基础.assets/image-20200120190842704.png)

最后的8字节反映了查询状态。

### 动态路由协议

RIP协议

周期性，每30s广播一次。路由内部优先使用静态配置，之后才是动态获得的。

其认为封包穿透16个服务器（16跳）的服务是不联通的。

## 网络层

### OSPF协议

也是动态路由协议，不过用在Internet上

![image-20200120200428253](计算机网络基础.assets/image-20200120200428253.png)

RIP选择是按照封包跳数，OFPS则是通过带宽选择。支持多区域，触发式更新。

触发式更新：网络内节点每10s互相发送hello包以确定其邻接节点，之后节点之间互相交换节点，使用Dijkstra算法计算出其中的最优路由表。如果有变化会动态更新链路状态。

多区域：将节点划分区域，区域和区域之间不会互相影响。注意：区域为骨干+附属，最多只支持二级

![image-20200120202133198](计算机网络基础.assets/image-20200120202133198.png)

### 外部网关协议BGP

各个子系统之间使用RIP 或者 OSPF，子系统之间的最段路使用BGP协议。自然每一个子系统需要暴露一个路由作为数据交换入口。

![image-20200120203815029](计算机网络基础.assets/image-20200120203815029.png)

![image-20200120204140616](计算机网络基础.assets/image-20200120204140616.png)

其实现原理就是将获取各个子系统的路由表并进行交换，形成一种高度抽象的树结构。

### VPN的功能

![image-20200120205233944](计算机网络基础.assets/image-20200120205233944.png)

### NAT和PAT

地址转换技术（NAT）是针对暴露在公网的路由设备而言的。

内网计算机访问外网时只拥有内网地址，为了保证发出去的数据包还能回来，在NAT路由中会将数据包的源地址替换为自己的公网IP，这样数据包就能找到公网的设备了；在数据包抵达时路由再将地址替换回内网地址并发给对应的主机。

PAT（端口映射）技术则是为了避免内网访问的端口冲突（端口不能有相同的，不然不知道给谁），会在出站时将端口替换，数据包回来时再将其替换回来以保证数据被接收。

实际应用中，NAT技术并不会节省IP资源（每一个内网映射一个**不同的**外网地址），真正实现节省功能的是PAT技术，外面的IP端口转换成内部的端口地址返回数据包。

这种模型里面的能正常访问，但是外面的无法访问内网，

![image-20200120233348675](计算机网络基础.assets/image-20200120233348675.png)

可以看到右边一列的内网端口是PAT分配的，左边是其统一向外界暴露的。

### IGMP组播管理协议

组播就是多拨，一台机子发送的数据被多个设备接收。

这个协议是用来管理组播成员的。

路由器会检查其管理的设备是否有参加会议的设备，如果有就会向上一级路由器请求多播数据包发送过来。

## 传输层

本节介绍两个喜闻乐见的协议：TCP和UDP

我们可以从请求资源的大小区分。

注意！QQ聊天是UDP、传文件是TCP、访问网站TCP、广播UDP

### 传输层和应用层之间的关系

| 应用层协议 | 传输层协议           |
| ---------- | -------------------- |
| http       | TCP + 80             |
| https      | TCP + 443            |
| ftp        | TCP + 21             |
| SMTP       | TCP + 25             |
| POP3       | TCP + 110            |
| RDP        | TCP + 3389           |
| 共享文件夹 | TCP + 445            |
| SQL        | TCP + 1433           |
| DNS        | UDP + 53 Or TCP + 53 |

### 应用层协议和服务之间的关系

### TCP协议特点

![image-20200121094525314](计算机网络基础.assets/image-20200121094525314.png)

TCP使用面向字节流的方式传输数据：首先将文件按照**任意大小**放入缓冲区中，之后在里面按照**任意大小**构造封包，将其传送到远程设备，远程设备也有缓冲区，在缓冲区将数据组装好之后，应用层上的程序可以按照任意方式读入数据。

值得注意的是这种传输的数据包一定是有序的。

**套接字Socket**：IP地址和端口号，因为TCP是点到点的传输，所以描述传输双方使用套接字。

#### TCP  如何实现可靠传输

由传输层实现

![image-20200121101345577](计算机网络基础.assets/image-20200121101345577.png)

![image-20200121101650314](计算机网络基础.assets/image-20200121101650314.png)

* ARQ协议

![image-20200121102135866](计算机网络基础.assets/image-20200121102135866.png)

服务器只有收到确认消息之后才会发送下一个数据包，如果等待一个来回时间收不到回应，则**自动**重发；如果回应的消息传过来太慢，则收到后什么都不做（不发送下一个包）

缺点：简单但是信道利用率太低

为了提高利用率，可以一次发多个包在等待确认，这就是**滑动窗口**技术。每一次将窗口中的包都发出去，之后队头的包确认消息收到之后才能将其剔除队头，在后面新加一个元素。

为了减少回执消息，近一步改进为客户端收到从开头开始连续的数据包后只会返回一个消息，而不是多个消息。如果中间丢包，则**后面的全部废弃**。

#### TCP报文段的首部格式

![image-20200121112340486](计算机网络基础.assets/image-20200121112340486.png)

| 字段             | 说明                                                         |
| ---------------- | ------------------------------------------------------------ |
| 源端口、目的端口 | 用于说明发送和接收双方的信息                                 |
| 序号seq          | 说明数据包中第一个字节是文件中的第几个字节                   |
| 确认号ack        | 下一次连接需要发送的序号（下一个包第一个字节的位置）         |
| 数据偏移         | 因为首部是可变的，所以要说明首部的长度                       |
| 保留             | 无用                                                         |
| URG              | 紧急标志，将高于缓存优先级发送。比如停止命令是一个数据包，应该在发送数据的队列中优先发送以立即停止操作。 |
| ACK              | 标记确认号是否有效，在没有接收任何数据时为0表无效            |
| PSH              | 发送的数据包将直接被对方接收，不进入对方的队列               |
| SYN              | 在请求建立通信时为1                                          |
| RSE              | 释放连接，异常结束                                           |
| FIN              | 通信完毕，释放连接                                           |

注意：数据偏移为4个字节，而且定义为4n，于是首部的最大长度为4 * 1111 == 60，也就是说除去开头20字节的固定部分之外可变部分最多40字节！

通过实验，我们发现序号事实上是“自己发送的数据包记录指针”（注意是在一次回话之中）

确认号是自己接收的数据包的情况，收多少就记录多少。

所以二者传输之间两个数字可以互相运算转化。

平均往返时间的计算

![image-20200121155142714](计算机网络基础.assets/image-20200121155142714.png)

为了最优化网路的等待时间。

#### 流量控制

通过调节发送窗口和接收窗口实现

#### 避免网络堵塞

网路中的所有计算机怎样避免将网络搞瘫痪

![image-20200121155639378](计算机网络基础.assets/image-20200121155639378.png)

![image-20200121160352345](计算机网络基础.assets/image-20200121160352345.png)

**慢开始算法**

![image-20200121161119338](计算机网络基础.assets/image-20200121161119338.png)

刚开始的时候连续发包数从1开始指数增加，当增加到**慢开始门限**之后，就变成线性增加，当出现拥塞之后，会将门限值设置成当前最大发包数量的一半，同时发包又从1开始循环。

**快重传、快恢复**

![image-20200121164317126](计算机网络基础.assets/image-20200121164317126.png)

在接收端知道发来的包有丢包时，他不会等到窗口都发完再回复，而是立马返回三条相同的信息说明丢失的包是哪一个，在A接收之后就认为网络出现堵塞了，不会将开始速度变成1开始，而是从新的门限速度开始发包。

所以说事实上A并不只有一个缓冲窗口，而是还有一个拥塞窗口。

注意按照上图拥塞窗口也有上限，不会超过对方接收窗口的大小。

### TCP连接的过程

![image-20200121165235317](计算机网络基础.assets/image-20200121165235317.png)

![image-20200121170304516](计算机网络基础.assets/image-20200121170304516.png)

三次握手，注意中间seq和ack值的计算！

![image-20200121170827893](计算机网络基础.assets/image-20200121170827893.png)

这是状态转换图，使用netstate -n 能够看到的。

### TCP结束过程

![image-20200121171340380](计算机网络基础.assets/image-20200121171340380.png)

使用四次挥手，中间建立的“通道”是保证最后的数据能够顺利发送。

最后会有一个4分钟左右的等待（TIME_WAIT）是为了保证最后一个包服务器收到了，如果没收到则会再发，于是要等待一段时间，保证一切都结束了。

## 应用层

每一个应用层协议就对应计算机上的一个服务。

